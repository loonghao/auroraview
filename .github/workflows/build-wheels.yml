name: Build Wheels

on:
  push:
    branches: [main]
    tags: ['*']
  pull_request:
    paths:
      - 'src/**'
      - 'python/**'
      - 'Cargo.toml'
      - 'Cargo.lock'
      - 'pyproject.toml'
  workflow_dispatch:
    inputs:
      reuse-pr-artifacts:
        description: 'Reuse artifacts from PR workflow (run_id)'
        required: false
        type: string
        default: ''
  workflow_call:
    inputs:
      test-wheel:
        required: false
        type: string
        default: 'true'
      python-version:
        required: false
        type: string
        default: '3.11'
      reuse-pr-artifacts:
        description: 'Reuse artifacts from PR workflow (run_id)'
        required: false
        type: string
        default: ''

permissions:
  contents: read
  actions: write # Required for uploading artifacts

jobs:
  # ============================================================================
  # ABI3 builds (Python 3.8+) - Single wheel works for all Python 3.8+ versions
  # ============================================================================

  # Linux builds (abi3)
  linux:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        target: [x86_64]

    steps:
      - uses: actions/checkout@v4

      - name: Build and Test Wheel
        uses: ./.github/actions/build-wheel
        with:
          target: ${{ matrix.target }}
          python-version: ${{ inputs.python-version }}
          test-wheel: ${{ inputs.test-wheel }}
          artifact-name: 'wheels-linux-${{ matrix.target }}'

  # Windows builds (abi3)
  windows:
    runs-on: windows-latest
    strategy:
      matrix:
        target: [x64]

    steps:
      - uses: actions/checkout@v4

      - name: Build and Test Wheel
        uses: ./.github/actions/build-wheel
        with:
          target: ${{ matrix.target }}
          python-version: ${{ inputs.python-version }}
          maturin-args: '--release --out dist --find-interpreter --features ext-module,win-webview2'
          test-wheel: ${{ inputs.test-wheel }}
          artifact-name: 'wheels-windows-${{ matrix.target }}'

  # macOS builds (abi3)
  macos:
    runs-on: macos-latest
    strategy:
      matrix:
        # Only build universal2 on macos-latest (ARM64 runner)
        # universal2 includes both x86_64 and arm64 architectures
        # Note: macos-13 (x86_64) was shut down in September 2025
        target: [universal2-apple-darwin]

    steps:
      - uses: actions/checkout@v4

      - name: Build and Test Wheel
        uses: ./.github/actions/build-wheel
        with:
          target: ${{ matrix.target }}
          python-version: ${{ inputs.python-version }}
          maturin-args: '--release --out dist --sdist --find-interpreter'
          test-wheel: ${{ inputs.test-wheel }}
          artifact-name: 'wheels-macos-${{ matrix.target }}'

  # ============================================================================
  # Python 3.7 builds (non-abi3) - Separate wheel for each platform
  # Note: Uses older Rust toolchain (1.80) for GLIBC compatibility with Ubuntu 22.04
  # ============================================================================

  # Linux Python 3.7 build
  linux-py37:
    runs-on: ubuntu-22.04  # Use Ubuntu 22.04 for Python 3.7 availability
    strategy:
      matrix:
        target: [x86_64]

    steps:
      - uses: actions/checkout@v4

      - name: Build Python 3.7 Wheel
        uses: ./.github/actions/build-wheel
        with:
          target: ${{ matrix.target }}
          python-version: '3.7'
          # Use Rust 1.80 for GLIBC 2.35 compatibility (Ubuntu 22.04)
          rust-version: '1.80'
          # Non-abi3 build: use python-bindings without abi3 feature
          maturin-args: '--release --out dist -i python3.7 --features python-bindings,ext-module'
          test-wheel: ${{ inputs.test-wheel }}
          artifact-name: 'wheels-linux-${{ matrix.target }}-py37'
          # Disable sccache to avoid potential compatibility issues
          use-sccache: 'false'

  # Windows Python 3.7 build
  windows-py37:
    runs-on: windows-2019  # Use older Windows for Python 3.7 compatibility
    strategy:
      matrix:
        target: [x64]

    steps:
      - uses: actions/checkout@v4

      - name: Build Python 3.7 Wheel
        uses: ./.github/actions/build-wheel
        with:
          target: ${{ matrix.target }}
          python-version: '3.7'
          # Non-abi3 build: use python-bindings without abi3 feature
          maturin-args: '--release --out dist -i python3.7 --features python-bindings,ext-module,win-webview2'
          test-wheel: ${{ inputs.test-wheel }}
          artifact-name: 'wheels-windows-${{ matrix.target }}-py37'
          # Disable sccache to avoid potential compatibility issues
          use-sccache: 'false'

  # macOS Python 3.7 build
  macos-py37:
    runs-on: macos-13  # Use x86_64 runner for Python 3.7 (no ARM64 Python 3.7)
    strategy:
      matrix:
        target: [x86_64-apple-darwin]

    steps:
      - uses: actions/checkout@v4

      - name: Build Python 3.7 Wheel
        uses: ./.github/actions/build-wheel
        with:
          target: ${{ matrix.target }}
          python-version: '3.7'
          # Non-abi3 build: use python-bindings without abi3 feature
          maturin-args: '--release --out dist -i python3.7 --features python-bindings,ext-module'
          test-wheel: ${{ inputs.test-wheel }}
          artifact-name: 'wheels-macos-${{ matrix.target }}-py37'
          # Disable sccache to avoid potential compatibility issues
          use-sccache: 'false'

